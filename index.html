<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Preferred Stocks Correlation Matrix</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .container { max-width: 800px; margin: auto; }
        .error { color: red; }
        .success { color: green; }
        button, select, input { margin: 5px; padding: 8px; }
        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        th, td { border: 1px solid #ddd; padding: 8px; text-align: center; }
        th { background-color: #f2f2f2; }
        .correlation-cell:hover { cursor: pointer; background-color: #e0e0e0; }
    </style>
</head>
<body>
    <div class="container">
        <h1>Preferred Stocks Correlation Matrix</h1>
        <p>Real-time correlation analysis powered by Alpha Vantage API</p>

        <div>
            <h2>Alpha Vantage API Configuration</h2>
            <label for="api-key">ðŸ”‘ API Key Required</label><br>
            <input type="text" id="api-key" placeholder="Enter your Alpha Vantage API key">
            <a href="https://www.alphavantage.co/support/#api-key" target="_blank">Get your free API key</a><br>
            <button id="activate-api">ðŸ”“ Activate API</button>
        </div>

        <div>
            <h2>Data Source</h2>
            <button id="real-data">ðŸš€ Use Real Market Data</button>
            <button id="demo-data">ðŸ“Š Use Demo Data</button>
        </div>

        <div>
            <h2>Stock Selection</h2>
            <label for="time-period">Time Period</label>
            <select id="time-period">
                <option value="30">30 Days</option>
                <option value="60">60 Days</option>
                <option value="90">90 Days</option>
                <option value="180">6 Months</option>
            </select><br>
            <label for="ticker-input">Custom Ticker</label>
            <input type="text" id="ticker-input" placeholder="e.g. BAC-P-A, MSFT">
            <button id="add-stock">Add Stock</button>
            <button id="refresh-data">Refresh Data</button>
            <p id="ticker-error" class="error"></p>
        </div>

        <div>
            <h2>Correlation Matrix</h2>
            <p>Strong Neg | Mod. Neg | Weak | Mod. Pos | Strong Pos</p>
            <p id="status">Enter your Alpha Vantage API key and select data source to start...</p>
            <table id="correlation-table"></table>
        </div>

        <div>
            <h2>Market Statistics</h2>
            <div id="pair-analysis">Click on a cell to see detailed analysis and financial data.</div>
        </div>
    </div>

    <script>
        let apiKey = '';
        let useDemoData = false;
        let stocks = [];
        const API_BASE_URL = 'https://www.alphavantage.co/query';
        const RATE_LIMIT_DELAY = 12000;

        const demoData = {
            'MSFT': { '2023-08-01': 330.1, '2023-08-02': 328.9, '2023-08-03': 329.5 },
            'AAPL': { '2023-08-01': 195.2, '2023-08-02': 192.6, '2023-08-03': 191.3 }
        };

        document.getElementById('activate-api').addEventListener('click', () => {
            apiKey = document.getElementById('api-key').value.trim();
            if (!apiKey) {
                updateStatus('LÃ¼tfen geÃ§erli bir API anahtarÄ± girin.', 'error');
                return;
            }
            updateStatus('API anahtarÄ± aktif edildi!', 'success');
        });

        document.getElementById('real-data').addEventListener('click', () => {
            useDemoData = false;
            updateStatus('GerÃ§ek piyasa verileri kullanÄ±lÄ±yor...', 'success');
            fetchData();
        });

        document.getElementById('demo-data').addEventListener('click', () => {
            useDemoData = true;
            updateStatus('Demo veriler kullanÄ±lÄ±yor...', 'success');
            renderCorrelationMatrix(calculateCorrelation(demoData));
        });

        document.getElementById('add-stock').addEventListener('click', () => {
            const ticker = document.getElementById('ticker-input').value.trim().toUpperCase();
            if (!isValidTicker(ticker)) {
                document.getElementById('ticker-error').textContent = 'GeÃ§ersiz sembol formatÄ±. Ã–rnek: BAC-P-A, AAPL';
                return;
            }
            if (!stocks.includes(ticker)) {
                stocks.push(ticker);
                document.getElementById('ticker-error').textContent = '';
                updateStatus(`Hisse eklendi: ${ticker}`, 'success');
                fetchData();
            }
        });

        document.getElementById('refresh-data').addEventListener('click', fetchData);

        function isValidTicker(ticker) {
            return /^[A-Z]+(-P-[A-Z])?$/.test(ticker);
        }

        function updateStatus(message, type) {
            const status = document.getElementById('status');
            status.textContent = message;
            status.className = type;
        }

        async function fetchPriceData(symbol) {
            const url = `${API_BASE_URL}?function=TIME_SERIES_DAILY&symbol=${symbol}&outputsize=compact&apikey=${apiKey}`;
            await new Promise(resolve => setTimeout(resolve, RATE_LIMIT_DELAY));
            const response = await fetch(url);
            const data = await response.json();
            if (data['Error Message']) throw new Error(data['Error Message']);
            return data['Time Series (Daily)'];
        }

        function calculateCorrelation(data) {
            const correlations = {};
            const dates = Object.keys(data[stocks[0]] || demoData['MSFT']).sort();
            const prices = stocks.map(stock => dates.map(date => parseFloat(data[stock]?.[date]?.['4. close'] || demoData[stock]?.[date] || 0)));

            for (let i = 0; i < stocks.length; i++) {
                for (let j = 0; j < stocks.length; j++) {
                    const key = `${stocks[i]}:${stocks[j]}`;
                    if (i === j) {
                        correlations[key] = 1;
                    } else {
                        const x = prices[i];
                        const y = prices[j];
                        const meanX = x.reduce((a, b) => a + b, 0) / x.length;
                        const meanY = y.reduce((a, b) => a + b, 0) / y.length;
                        const cov = x.reduce((sum, xi, idx) => sum + (xi - meanX) * (y[idx] - meanY), 0) / x.length;
                        const stdX = Math.sqrt(x.reduce((sum, xi) => sum + (xi - meanX) ** 2, 0) / x.length);
                        const stdY = Math.sqrt(y.reduce((sum, yi) => sum + (yi - meanY) ** 2, 0) / y.length);
                        correlations[key] = cov / (stdX * stdY) || 0;
                    }
                }
            }
            return correlations;
        }

        async function fetchData() {
            if (useDemoData) {
                renderCorrelationMatrix(calculateCorrelation(demoData));
                return;
            }

            if (!apiKey) {
                updateStatus('LÃ¼tfen Ã¶nce API anahtarÄ±nÄ± girin.', 'error');
                return;
            }

            if (stocks.length < 2) {
                updateStatus('Korelasyon matrisi iÃ§in en az 2 hisse senedi ekleyin.', 'error');
                return;
            }

            updateStatus('Veriler Ã§ekiliyor...', 'success');
            try {
                const data = {};
                for (const symbol of stocks) {
                    data[symbol] = await fetchPriceData(symbol);
                }
                const correlations = calculateCorrelation(data);
                renderCorrelationMatrix(correlations);
            } catch (error) {
                updateStatus(`Hata: ${error.message}`, 'error');
                console.error('API YanÄ±tÄ±:', error);
            }
        }

        function renderCorrelationMatrix(correlations) {
            const table = document.getElementById('correlation-table');
            table.innerHTML = '';

            let row = '<tr><th></th>';
            stocks.forEach(stock => row += `<th>${stock}</th>`);
            row += '</tr>';
            table.innerHTML += row;

            stocks.forEach((stock1, i) => {
                row = `<tr><th>${stock1}</th>`;
                stocks.forEach((stock2, j) => {
                    const correlation = correlations[`${stock1}:${stock2}`] || 0;
                    row += `<td class="correlation-cell" data-pair="${stock1}-${stock2}">${correlation.toFixed(2)}</td>`;
                });
                row += '</tr>';
                table.innerHTML += row;
            });

            document.querySelectorAll('.correlation-cell').forEach(cell => {
                cell.addEventListener('click', () => {
                    const pair = cell.dataset.pair;
                    document.getElementById('pair-analysis').textContent = `SeÃ§ilen Ã§ift: ${pair}. DetaylÄ± analiz burada gÃ¶sterilecek.`;
                });
            });
        }
    </script>
</body>
</html>
