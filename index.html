<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Preferred Stocks Correlation Matrix</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .container { max-width: 800px; margin: auto; }
        .error { color: red; }
        .success { color: green; }
        button, select, input { margin: 5px; padding: 8px; }
        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        th, td { border: 1px solid #ddd; padding: 8px; text-align: center; }
        th { background-color: #f2f2f2; }
        .correlation-cell:hover { cursor: pointer; background-color: #e0e0e0; }
    </style>
</head>
<body>
    <div class="container">
        <h1>Preferred Stocks Correlation Matrix</h1>
        <p>Real-time correlation analysis powered by Alpha Vantage API</p>

        <div>
            <h2>Alpha Vantage API Configuration</h2>
            <label for="api-key">ðŸ”‘ API Key Required</label><br>
            <input type="text" id="api-key" placeholder="Enter your Alpha Vantage API key">
            <a href="https://www.alphavantage.co/support/#api-key" target="_blank">Get your free API key</a><br>
            <button id="activate-api">ðŸ”“ Activate API</button>
        </div>

        <div>
            <h2>Data Source</h2>
            <button id="real-data">ðŸš€ Use Real Market Data</button>
            <button id="demo-data">ðŸ“Š Use Demo Data</button>
        </div>

        <div>
            <h2>Stock Selection</h2>
            <label for="time-period">Time Period</label>
            <select id="time-period">
                <option value="30">30 Days</option>
                <option value="60">60 Days</option>
                <option value="90">90 Days</option>
                <option value="180">6 Months</option>
            </select><br>
            <label for="ticker-input">Custom Ticker</label>
            <input type="text" id="ticker-input" placeholder="e.g. BAC-P-A, MSFT">
            <button id="add-stock">Add Stock</button>
            <button id="refresh-data">Refresh Data</button>
            <p id="ticker-error" class="error"></p>
        </div>

        <div>
            <h2>Correlation Matrix</h2>
            <p>Strong Neg | Mod. Neg | Weak | Mod. Pos | Strong Pos</p>
            <p id="status">Enter your Alpha Vantage API key and select data source to start...</p>
            <table id="correlation-table"></table>
        </div>

        <div>
            <h2>Market Statistics</h2>
            <div id="pair-analysis">Click on a cell to see detailed analysis and financial data.</div>
        </div>
    </div>

    <script>
        // API ve durum deÄŸiÅŸkenleri
        let apiKey = '';
        let useDemoData = false;
        let stocks = [];
        const API_BASE_URL = 'https://www.alphavantage.co/query';
        const RATE_LIMIT_DELAY = 12000; // 12 saniye (5 istek/dakika iÃ§in)

        // Demo veri Ã¶rneÄŸi
        const demoData = {
            'BAC-P-A': { '2023-08-01': 25.5, '2023-08-02': 25.7, /* ... */ },
            'MSFT': { '2023-08-01': 330.1, '2023-08-02': 328.9, /* ... */ }
        };

        // API anahtarÄ±nÄ± aktive et
        document.getElementById('activate-api').addEventListener('click', () => {
            apiKey = document.getElementById('api-key').value.trim();
            if (!apiKey) {
                updateStatus('LÃ¼tfen geÃ§erli bir API anahtarÄ± girin.', 'error');
                return;
            }
            updateStatus('API anahtarÄ± aktif edildi!', 'success');
        });

        // Veri kaynaÄŸÄ±nÄ± seÃ§
        document.getElementById('real-data').addEventListener('click', () => {
            useDemoData = false;
            updateStatus('GerÃ§ek piyasa verileri kullanÄ±lÄ±yor...', 'success');
            fetchData();
        });

        document.getElementById('demo-data').addEventListener('click', () => {
            useDemoData = true;
            updateStatus('Demo veriler kullanÄ±lÄ±yor...', 'success');
            renderCorrelationMatrix(demoData);
        });

        // Hisse ekle
        document.getElementById('add-stock').addEventListener('click', () => {
            const ticker = document.getElementById('ticker-input').value.trim().toUpperCase();
            if (!isValidTicker(ticker)) {
                document.getElementById('ticker-error').textContent = 'GeÃ§ersiz sembol formatÄ±. Ã–rnek: BAC-P-A, AAPL';
                return;
            }
            if (!stocks.includes(ticker)) {
                stocks.push(ticker);
                document.getElementById('ticker-error').textContent = '';
                updateStatus(`Hisse eklendi: ${ticker}`, 'success');
                fetchData();
            }
        });

        // Verileri yenile
        document.getElementById('refresh-data').addEventListener('click', fetchData);

        // Ticker formatÄ±nÄ± doÄŸrula (Ã¶rn. AAPL veya BAC-P-A)
        function isValidTicker(ticker) {
            return /^[A-Z]+(-P-[A-Z])?$/.test(ticker);
        }

        // Durum mesajlarÄ±nÄ± gÃ¼ncelle
        function updateStatus(message, type) {
            const status = document.getElementById('status');
            status.textContent = message;
            status.className = type;
        }

        // API'den veri Ã§ekme
        async function fetchData() {
            if (useDemoData) {
                renderCorrelationMatrix(demoData);
                return;
            }

            if (!apiKey) {
                updateStatus('LÃ¼tfen Ã¶nce API anahtarÄ±nÄ± girin.', 'error');
                return;
            }

            if (stocks.length < 2) {
                updateStatus('Korelasyon matrisi iÃ§in en az 2 hisse senedi ekleyin.', 'error');
                return;
            }

            updateStatus('Veriler Ã§ekiliyor...', 'success');
            const timePeriod = document.getElementById('time-period').value;
            const symbols = stocks.join(',');
            const url = `${API_BASE_URL}?function=ANALYTICS_FIXED_WINDOW&SYMBOLS=${symbols}&RANGE=${timePeriod}d&INTERVAL=DAILY&OHLC=close&CALCULATIONS=CORRELATION(method=PEARSON)&apikey=${apiKey}`;

            try {
                await new Promise(resolve => setTimeout(resolve, RATE_LIMIT_DELAY)); // Rate limit iÃ§in bekle
                const response = await fetch(url);
                const data = await response.json();

                if (data['Error Message']) {
                    throw new Error(data['Error Message']);
                }

                if (!data['correlation']) {
                    throw new Error('Korelasyon verisi bulunamadÄ±.');
                }

                renderCorrelationMatrix(data);
            } catch (error) {
                updateStatus(`Hata: ${error.message}`, 'error');
            }
        }

        // Korelasyon matrisini Ã§iz
        function renderCorrelationMatrix(data) {
            const table = document.getElementById('correlation-table');
            table.innerHTML = '';

            if (useDemoData) {
                // Demo veri iÃ§in basit bir korelasyon simÃ¼lasyonu
                const headers = stocks;
                let row = '<tr><th></th>';
                headers.forEach(stock => row += `<th>${stock}</th>`);
                row += '</tr>';
                table.innerHTML += row;

                headers.forEach((stock1, i) => {
                    row = `<tr><th>${stock1}</th>`;
                    headers.forEach((stock2, j) => {
                        const correlation = i === j ? 1 : (Math.random() * 2 - 1).toFixed(2); // Rastgele demo korelasyon
                        row += `<td class="correlation-cell" data-pair="${stock1}-${stock2}">${correlation}</td>`;
                    });
                    row += '</tr>';
                    table.innerHTML += row;
                });
            } else {
                // GerÃ§ek API verisi
                const correlations = data['correlation'];
                const headers = stocks;
                let row = '<tr><th></th>';
                headers.forEach(stock => row += `<th>${stock}</th>`);
                row += '</tr>';
                table.innerHTML += row;

                headers.forEach((stock1, i) => {
                    row = `<tr><th>${stock1}</th>`;
                    headers.forEach((stock2, j) => {
                        const correlation = correlations[`${stock1}:${stock2}`] || 1;
                        row += `<td class="correlation-cell" data-pair="${stock1}-${stock2}">${correlation.toFixed(2)}</td>`;
                    });
                    row += '</tr>';
                    table.innerHTML += row;
                });
            }

            // HÃ¼crelere tÄ±klama olayÄ± ekle
            document.querySelectorAll('.correlation-cell').forEach(cell => {
                cell.addEventListener('click', () => {
                    const pair = cell.dataset.pair;
                    document.getElementById('pair-analysis').textContent = `SeÃ§ilen Ã§ift: ${pair}. DetaylÄ± analiz burada gÃ¶sterilecek.`;
                });
            });
        }
    </script>
</body>
</html>
