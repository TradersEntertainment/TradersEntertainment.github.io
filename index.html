<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Enhanced Preferred Stocks Correlation Matrix</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Arial', sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            color: #fff;
            min-height: 100vh;
        }
        .container { max-width: 1400px; margin: 0 auto; padding: 20px; }
        .header { text-align: center; margin-bottom: 40px; }
        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            background: linear-gradient(45deg, #00d4ff, #00ff88);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        .header p { font-size: 1.1em; color: #b8c5d6; }
        .api-setup, .controls, .stocks-info, .matrix-container, .info-panel {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 30px;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        .api-input, .control-row { display: flex; gap: 10px; align-items: center; flex-wrap: wrap; }
        .api-input { margin-top: 15px; }
        .control-row { margin-bottom: 20px; }
        .control-group { display: flex; flex-direction: column; gap: 8px; }
        label { font-weight: 600; color: #e0e6ed; font-size: 0.9em; }
        select, input[type="text"] {
            padding: 10px 15px;
            border: none;
            border-radius: 8px;
            background: rgba(255, 255, 255, 0.15);
            color: white;
            font-size: 14px;
            min-width: 150px;
        }
        select:focus, input:focus { outline: none; box-shadow: 0 0 0 2px #00d4ff; }
        .btn {
            padding: 12px 25px;
            background: linear-gradient(45deg, #00d4ff, #00ff88);
            border: none;
            border-radius: 8px;
            color: white;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 14px;
        }
        .btn:hover { transform: translateY(-2px); box-shadow: 0 8px 25px rgba(0, 212, 255, 0.3); }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; transform: none; box-shadow: none; }
        .stocks-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 15px; margin-top: 20px; }
        .stock-card {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            padding: 15px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            transition: all 0.3s ease;
        }
        .stock-card:hover { transform: translateY(-2px); box-shadow: 0 8px 20px rgba(0, 212, 255, 0.2); }
        .stock-symbol { font-size: 1.1em; font-weight: bold; color: #00d4ff; margin-bottom: 8px; }
        .stock-details { font-size: 0.9em; color: #b8c5d6; line-height: 1.4; }
        .stock-type { display: inline-block; background: linear-gradient(45deg, #6c5ce7, #fd79a8); padding: 2px 8px; border-radius: 4px; font-size: 0.8em; font-weight: bold; margin-bottom: 5px; }
        .matrix-container { overflow-x: auto; }
        .matrix-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 10px;
            overflow: hidden;
            font-size: 0.85em;
        }
        .matrix-table th, .matrix-table td { padding: 10px 8px; text-align: center; border: 1px solid rgba(255, 255, 255, 0.1); font-weight: 500; white-space: nowrap; }
        .matrix-table th { background: linear-gradient(45deg, #00d4ff22, #00ff8822); font-weight: 700; font-size: 0.9em; }
        .correlation-cell { font-weight: 600; border-radius: 6px; cursor: pointer; transition: all 0.3s ease; }
        .correlation-cell:hover { transform: scale(1.1); z-index: 10; box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3); }
        .legend { display: flex; justify-content: center; align-items: center; gap: 15px; margin-bottom: 20px; flex-wrap: wrap; }
        .legend-item { display: flex; align-items: center; gap: 8px; font-size: 0.9em; }
        .legend-color { width: 20px; height: 20px; border-radius: 4px; border: 1px solid rgba(255, 255, 255, 0.3); }
        .loading, .error, .success { text-align: center; padding: 15px; border-radius: 8px; margin: 20px 0; }
        .loading { font-size: 1.2em; color: #b8c5d6; }
        .error { background: rgba(255, 0, 0, 0.1); border: 1px solid rgba(255, 0, 0, 0.3); color: #ff6b6b; }
        .success { background: rgba(0, 255, 0, 0.1); border: 1px solid rgba(0, 255, 0, 0.3); color: #00ff88; }
        .stats { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-top: 20px; }
        .stat-card { background: rgba(255, 255, 255, 0.1); padding: 15px; border-radius: 10px; text-align: center; }
        .stat-value { font-size: 1.5em; font-weight: bold; margin-bottom: 5px; }
        .stat-label { font-size: 0.9em; color: #b8c5d6; }
        .api-status { display: inline-block; width: 12px; height: 12px; border-radius: 50%; margin-right: 8px; }
        .status-online { background-color: #00ff88; }
        .status-offline { background-color: #ff4757; }
        .status-loading { background-color: #fdcb6e; animation: pulse 2s infinite; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
        /* Modal Styles */
        .modal {
            display: none; position: fixed; z-index: 1000; left: 0; top: 0;
            width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.6);
            backdrop-filter: blur(5px);
        }
        .modal-content {
            background: linear-gradient(135deg, #16213e 0%, #1a1a2e 100%);
            margin: 15% auto; padding: 30px; border: 1px solid rgba(255, 255, 255, 0.2);
            width: 90%; max-width: 500px; border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
            position: relative;
        }
        .close-btn { color: #aaa; float: right; font-size: 28px; font-weight: bold; cursor: pointer; position: absolute; top: 10px; right: 20px; }
        .close-btn:hover, .close-btn:focus { color: white; text-decoration: none; }
        .modal-content h3 { color: #00d4ff; margin-bottom: 20px; }
        .modal-content .control-group { margin-bottom: 15px; }
        .modal-content input { width: 100%; }
        @media (max-width: 768px) { .control-row, .api-input { flex-direction: column; align-items: stretch; } .control-group { width: 100%; } select, input { min-width: auto; width: 100%; } }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Enhanced Preferred Stocks Correlation Matrix</h1>
            <p>Real-time correlation analysis with detailed preferred stock information</p>
        </div>

        <div class="api-setup">
            <h3 style="color: #00ff88; margin-bottom: 15px;">
                <span class="api-status status-loading" id="apiStatus"></span> Data Source Configuration
            </h3>
            <p style="color: #b8c5d6; margin-bottom: 15px;">Choose your data source for analysis.</p>
            <div class="api-input">
                <button class="btn" id="btnRealData">🚀 Use Real Market Data</button>
                <button class="btn" id="btnDemoData" style="background: linear-gradient(45deg, #6c5ce7, #fd79a8);">📊 Use Demo Data</button>
                <button class="btn" id="btnConfigApi" style="background: linear-gradient(45deg, #ffa500, #ff6347);">🔑 Configure API Keys</button>
            </div>
            <div id="apiMessage" style="margin-top:15px;"></div>
        </div>

        <div class="stocks-info">
            <h3 style="color: #00d4ff;">📋 Preferred Stocks in Analysis</h3>
            <div class="stocks-grid" id="stocksGrid"></div>
        </div>

        <div class="controls">
            <div class="control-row">
                <div class="control-group"><label>Time Period</label><select id="timePeriod"><option value="15">15 Days</option><option value="30">30 Days</option><option value="60" selected>60 Days</option><option value="90">90 Days</option><option value="180">6 Months</option><option value="365">1 Year</option></select></div>
                <div class="control-group"><label>Update Frequency</label><select id="updateFreq"><option value="daily" selected>Daily</option><option value="weekly">Weekly</option></select></div>
                <div class="control-group"><label>Add Custom Ticker</label><input type="text" id="customTicker" placeholder="e.g., BAC-PK"></div>
                <button class="btn" id="btnAddStock">Add Stock</button>
                <button class="btn" id="btnRefresh" disabled>Refresh Data</button>
            </div>
        </div>

        <div class="matrix-container">
            <div class="legend">
                <div class="legend-item"><div class="legend-color" style="background: #ff4757;"></div><span>Strong Neg (-1.0 to -0.7)</span></div>
                <div class="legend-item"><div class="legend-color" style="background: #ff7675;"></div><span>Moderate Neg (-0.7 to -0.3)</span></div>
                <div class="legend-item"><div class="legend-color" style="background: #fdcb6e;"></div><span>Weak (-0.3 to 0.3)</span></div>
                <div class="legend-item"><div class="legend-color" style="background: #6c5ce7;"></div><span>Moderate Pos (0.3 to 0.7)</span></div>
                <div class="legend-item"><div class="legend-color" style="background: #00b894;"></div><span>Strong Pos (0.7 to 1.0)</span></div>
            </div>
            <div id="matrixContent"><div class="loading">Choose your data source to start analysis...</div></div>
        </div>

        <div class="info-panel">
            <h3 style="margin-bottom: 15px; color: #00d4ff;">Market Statistics</h3>
            <div class="stats" id="statsContainer"></div>
            <div style="margin-top: 25px;">
                <h4 style="color: #00ff88; margin-bottom: 10px;">Selected Pair Analysis</h4>
                <div id="pairAnalysis" style="color: #b8c5d6;">Click on any correlation cell to see detailed analysis.</div>
            </div>
        </div>
    </div>

    <div id="apiKeyModal" class="modal">
        <div class="modal-content">
            <span class="close-btn">&times;</span>
            <h3>🔑 API Key Configuration</h3>
            <p style="color: #b8c5d6; font-size: 0.9em; margin-bottom: 20px;">
                For best results, get free API keys. They will be saved in your browser's local storage.
                <strong style="color:#ffa500;">Warning:</strong> Do not use this on a public computer.
            </p>
            <div class="control-group">
                <label>Alpha Vantage API Key</label>
                <input type="text" id="alphaVantageKey" placeholder="Get free key from alphavantage.co">
            </div>
            <div class="control-group">
                <label>Financial Modeling Prep (FMP) API Key</label>
                <input type="text" id="fmpKey" placeholder="Get free key from financialmodelingprep.com">
            </div>
            <button class="btn" id="btnSaveApiKeys" style="margin-top: 10px;">Save Keys</button>
        </div>
    </div>

    <script>
        'use strict';

        // --- CONFIGURATION AND STATE ---
        const config = {
            apiKeys: {
                alphaVantage: '',
                fmp: ''
            },
            useDemo: false
        };

        let preferredStocksInfo = {
            'BAC-PK': { name: 'Bank of America Corp Series L', type: 'Fixed-to-Floating', dividend: '6.25%', callDate: '2026-03-15', maturityDate: 'Perpetual', issuer: 'Bank of America' },
            'BAC-PL': { name: 'Bank of America Corp Series M', type: 'Fixed Rate', dividend: '6.375%', callDate: '2025-12-15', maturityDate: 'Perpetual', issuer: 'Bank of America' },
            'JPM-PC': { name: 'JPMorgan Chase & Co Series C', type: 'Fixed Rate', dividend: '6.125%', callDate: '2025-05-01', maturityDate: 'Perpetual', issuer: 'JPMorgan Chase' },
            'JPM-PD': { name: 'JPMorgan Chase & Co Series D', type: 'Fixed-to-Floating', dividend: '6.20%', callDate: '2026-07-31', maturityDate: 'Perpetual', issuer: 'JPMorgan Chase' },
            'WFC-PQ': { name: 'Wells Fargo & Co Series Q', type: 'Fixed-to-Floating', dividend: '5.85%', callDate: '2025-06-15', maturityDate: 'Perpetual', issuer: 'Wells Fargo' },
            'WFC-PR': { name: 'Wells Fargo & Co Series R', type: 'Fixed Rate', dividend: '6.625%', callDate: '2027-03-15', maturityDate: 'Perpetual', issuer: 'Wells Fargo' },
            'C-PN': { name: 'Citigroup Inc Series N', type: 'Fixed-to-Floating', dividend: '6.875%', callDate: '2026-05-15', maturityDate: 'Perpetual', issuer: 'Citigroup' },
            'GS-PK': { name: 'Goldman Sachs Group Series K', type: 'Fixed-to-Floating', dividend: '6.30%', callDate: '2025-10-01', maturityDate: 'Perpetual', issuer: 'Goldman Sachs' },
            'MS-PI': { name: 'Morgan Stanley Series I', type: 'Fixed Rate', dividend: '6.375%', callDate: '2026-01-15', maturityDate: 'Perpetual', issuer: 'Morgan Stanley' },
            'USB-PH': { name: 'US Bancorp Series H', type: 'Fixed-to-Floating', dividend: '5.50%', callDate: '2025-03-15', maturityDate: 'Perpetual', issuer: 'US Bancorp' },
            'PNC-PP': { name: 'PNC Financial Services Series P', type: 'Fixed Rate', dividend: '6.125%', callDate: '2025-09-01', maturityDate: 'Perpetual', issuer: 'PNC Financial' },
            'TFC-PI': { name: 'Truist Financial Corp Series I', type: 'Fixed-to-Floating', dividend: '5.625%', callDate: '2025-11-01', maturityDate: 'Perpetual', issuer: 'Truist Financial' }
        };
        
        let correlationMatrix = {};

        // --- DOM ELEMENTS ---
        const DOMElements = {
            apiStatus: document.getElementById('apiStatus'),
            apiMessage: document.getElementById('apiMessage'),
            stocksGrid: document.getElementById('stocksGrid'),
            matrixContent: document.getElementById('matrixContent'),
            statsContainer: document.getElementById('statsContainer'),
            pairAnalysis: document.getElementById('pairAnalysis'),
            customTickerInput: document.getElementById('customTicker'),
            timePeriodSelect: document.getElementById('timePeriod'),
            // Buttons
            btnRealData: document.getElementById('btnRealData'),
            btnDemoData: document.getElementById('btnDemoData'),
            btnConfigApi: document.getElementById('btnConfigApi'),
            btnAddStock: document.getElementById('btnAddStock'),
            btnRefresh: document.getElementById('btnRefresh'),
            // Modal
            modal: document.getElementById('apiKeyModal'),
            btnCloseModal: document.querySelector('.close-btn'),
            btnSaveApiKeys: document.getElementById('btnSaveApiKeys'),
            alphaVantageKeyInput: document.getElementById('alphaVantageKey'),
            fmpKeyInput: document.getElementById('fmpKey'),
        };

        // --- INITIALIZATION ---
        document.addEventListener('DOMContentLoaded', () => {
            loadApiKeys();
            displayStocksInfo();
            updateApiStatus('offline');
            showMessage('success', 'Welcome! Please choose a data source or configure API keys to begin.');
            setupEventListeners();
        });

        function setupEventListeners() {
            DOMElements.btnRealData.addEventListener('click', useRealData);
            DOMElements.btnDemoData.addEventListener('click', useDemoData);
            DOMElements.btnConfigApi.addEventListener('click', () => DOMElements.modal.style.display = 'block');
            DOMElements.btnAddStock.addEventListener('click', addCustomStock);
            DOMElements.btnRefresh.addEventListener('click', refreshMatrix);
            // Modal events
            DOMElements.btnCloseModal.addEventListener('click', () => DOMElements.modal.style.display = 'none');
            DOMElements.btnSaveApiKeys.addEventListener('click', saveApiKeys);
            window.addEventListener('click', (event) => {
                if (event.target == DOMElements.modal) DOMElements.modal.style.display = 'none';
            });
        }
        
        // --- API & DATA MANAGEMENT ---
        function saveApiKeys() {
            config.apiKeys.alphaVantage = DOMElements.alphaVantageKeyInput.value.trim();
            config.apiKeys.fmp = DOMElements.fmpKeyInput.value.trim();
            localStorage.setItem('apiKeys', JSON.stringify(config.apiKeys));
            DOMElements.modal.style.display = 'none';
            showMessage('success', '✅ API keys saved successfully in browser storage!');
            testApiConnectivity();
        }

        function loadApiKeys() {
            const savedKeys = localStorage.getItem('apiKeys');
            if (savedKeys) {
                config.apiKeys = JSON.parse(savedKeys);
                DOMElements.alphaVantageKeyInput.value = config.apiKeys.alphaVantage || '';
                DOMElements.fmpKeyInput.value = config.apiKeys.fmp || '';
            }
        }
        
        async function fetchStockDetails(symbol) {
            if (!config.apiKeys.fmp) return null;
            try {
                const url = `https://financialmodelingprep.com/api/v3/profile/${symbol}?apikey=${config.apiKeys.fmp}`;
                const response = await fetch(url);
                if (!response.ok) return null;
                const data = await response.json();
                if (data && data.length > 0) {
                    return { name: data[0].companyName, issuer: data[0].companyName.split(' ')[0] };
                }
                return null;
            } catch (error) {
                console.error(`FMP Details Error for ${symbol}:`, error);
                return null;
            }
        }

        // --- DATA FETCHING (ROBUST & PARALLEL) ---
        const apiProviders = [
            async (symbol, period) => { // Provider 1: AllOrigins Proxy
                const endDate = new Date();
                const startDate = new Date(endDate - parseInt(period) * 24 * 60 * 60 * 1000 * 1.5);
                const yahooUrl = `https://query1.finance.yahoo.com/v8/finance/chart/${symbol}?period1=${Math.floor(startDate.getTime() / 1000)}&period2=${Math.floor(endDate.getTime() / 1000)}&interval=1d`;
                const proxyUrl = `https://api.allorigins.win/get?url=${encodeURIComponent(yahooUrl)}`;
                const response = await fetch(proxyUrl);
                if (!response.ok) throw new Error('AllOrigins proxy fetch failed');
                const data = await response.json();
                const yahooData = JSON.parse(data.contents);
                const prices = yahooData?.chart?.result?.[0]?.indicators?.quote?.[0]?.close;
                if (!prices) throw new Error('Invalid data structure from Yahoo via AllOrigins');
                return prices.filter(p => p !== null).slice(-parseInt(period));
            },
            async (symbol, period) => { // Provider 2: Financial Modeling Prep
                if (!config.apiKeys.fmp) throw new Error('FMP API key not configured');
                const url = `https://financialmodelingprep.com/api/v3/historical-price-full/${symbol}?apikey=${config.apiKeys.fmp}`;
                const response = await fetch(url);
                if (!response.ok) throw new Error('FMP fetch failed');
                const data = await response.json();
                if (!data.historical) throw new Error(`FMP Error: ${data['Error Message'] || 'No historical data'}`);
                return data.historical.slice(0, parseInt(period)).map(d => d.close).reverse();
            },
            async (symbol, period) => { // Provider 3: Alpha Vantage
                if (!config.apiKeys.alphaVantage) throw new Error('Alpha Vantage API key not configured');
                const url = `https://www.alphavantage.co/query?function=TIME_SERIES_DAILY&symbol=${symbol}&apikey=${config.apiKeys.alphaVantage}`;
                const response = await fetch(url);
                if (!response.ok) throw new Error('Alpha Vantage fetch failed');
                const data = await response.json();
                const timeSeries = data['Time Series (Daily)'];
                if (!timeSeries) throw new Error(`Alpha Vantage Error: ${data['Error Message'] || data['Note'] || 'Invalid data'}`);
                return Object.values(timeSeries).map(d => parseFloat(d['4. close'])).slice(0, parseInt(period)).reverse();
            }
        ];

        async function fetchStockData(symbol, period) {
            if (config.useDemo) return generateDemoStockData(period);

            for (const provider of apiProviders) {
                try {
                    const data = await provider(symbol, period);
                    if (data && data.length >= 5) {
                        console.log(`✅ Fetched ${symbol} using ${provider.name || 'provider'}`);
                        return data;
                    }
                } catch (error) {
                    console.warn(`⚠️ Provider failed for ${symbol}:`, error.message);
                }
            }
            throw new Error(`All API providers failed for ${symbol}`);
        }

        function generateDemoStockData(period) {
            const prices = [];
            let price = 25 + Math.random() * 50;
            const trend = (Math.random() - 0.5) * 0.01;
            for (let i = 0; i < parseInt(period) * 1.5; i++) {
                price *= (1 + trend + (Math.random() - 0.5) * 0.015);
                prices.push(parseFloat(price.toFixed(2)));
            }
            return prices.slice(-parseInt(period));
        }

        // --- CORE LOGIC (MATRIX CALCULATION) ---
        async function createCorrelationMatrix() {
            const period = DOMElements.timePeriodSelect.value;
            const stocks = Object.keys(preferredStocksInfo);
            const stockData = {};
            
            updateApiStatus('loading');
            DOMElements.matrixContent.innerHTML = `<div class="loading">🚀 Fetching data for ${stocks.length} stocks simultaneously...</div>`;
            
            const promises = stocks.map(symbol => fetchStockData(symbol, period));
            const results = await Promise.allSettled(promises);
            
            const failedStocks = [];
            results.forEach((result, index) => {
                const symbol = stocks[index];
                if (result.status === 'fulfilled') {
                    stockData[symbol] = result.value.reverse(); // Newest first
                } else {
                    console.error(`❌ Failed to fetch data for ${symbol}:`, result.reason);
                    failedStocks.push(symbol);
                }
            });

            if(failedStocks.length > 0) {
                showMessage('error', `Could not fetch data for: ${failedStocks.join(', ')}. They will be excluded from the analysis.`);
            }

            const validStocks = Object.keys(stockData);
            if(validStocks.length < 2) {
                showMessage('error', '❌ Not enough stock data to create a correlation matrix. Please check API keys or use demo data.');
                DOMElements.matrixContent.innerHTML = '';
                updateApiStatus('offline');
                return;
            }

            DOMElements.matrixContent.innerHTML = '<div class="loading">🧮 Calculating correlations...</div>';
            
            correlationMatrix = {};
            validStocks.forEach(stock1 => {
                correlationMatrix[stock1] = {};
                validStocks.forEach(stock2 => {
                    correlationMatrix[stock1][stock2] = (stock1 === stock2) ? 1.0 :
                        calculateCorrelation(stockData[stock1], stockData[stock2]);
                });
            });

            displayMatrix();
            updateStats();
            updateApiStatus('online');
            const source = config.useDemo ? 'demo data' : 'real market data';
            showMessage('success', `✅ Correlation matrix updated using ${source}!`);
        }

        // --- CALCULATION HELPERS ---
        function calculateReturns(prices) {
            const returns = [];
            for (let i = 1; i < prices.length; i++) {
                returns.push((prices[i-1] - prices[i]) / prices[i]);
            }
            return returns;
        }

        function calculateCorrelation(prices1, prices2) {
            const returns1 = calculateReturns(prices1);
            const returns2 = calculateReturns(prices2);
            const n = Math.min(returns1.length, returns2.length);
            if (n < 2) return 0;

            const mean1 = returns1.reduce((a, b) => a + b) / n;
            const mean2 = returns2.reduce((a, b) => a + b) / n;
            let num = 0, den1 = 0, den2 = 0;
            for (let i = 0; i < n; i++) {
                const diff1 = returns1[i] - mean1;
                const diff2 = returns2[i] - mean2;
                num += diff1 * diff2;
                den1 += diff1 * diff1;
                den2 += diff2 * diff2;
            }
            const den = Math.sqrt(den1 * den2);
            return den === 0 ? 0 : parseFloat((num / den).toFixed(3));
        }

        // --- UI UPDATE FUNCTIONS ---
        function displayStocksInfo() {
            let html = '';
            Object.entries(preferredStocksInfo).forEach(([symbol, stock]) => {
                const callDate = (stock.callDate && stock.callDate !== 'N/A') ? new Date(stock.callDate).toLocaleDateString() : 'N/A';
                html += `
                    <div class="stock-card">
                        <div class="stock-symbol">${symbol}</div>
                        <div class="stock-type">${stock.type || 'Unknown'}</div>
                        <div class="stock-details">
                            <strong>${stock.issuer || 'N/A'}</strong><br>
                            Dividend: <span style="color: #00ff88;">${stock.dividend || 'N/A'}</span><br>
                            Call Date: <span style="color: #fdcb6e;">${callDate}</span><br>
                        </div>
                    </div>`;
            });
            DOMElements.stocksGrid.innerHTML = html;
        }
        
        function displayMatrix() {
            const stocks = Object.keys(correlationMatrix);
            let html = '<table class="matrix-table"><tr><th></th>';
            stocks.forEach(stock => html += `<th>${stock}</th>`);
            html += '</tr>';
            stocks.forEach(stock1 => {
                html += `<tr><th>${stock1}</th>`;
                stocks.forEach(stock2 => {
                    const correlation = correlationMatrix[stock1][stock2];
                    const color = getCorrelationColor(correlation);
                    html += `<td class="correlation-cell" style="background-color: ${color};" onclick="selectPair('${stock1}', '${stock2}', ${correlation})">${correlation.toFixed(3)}</td>`;
                });
                html += '</tr>';
            });
            html += '</table>';
            DOMElements.matrixContent.innerHTML = html;
        }

        function getCorrelationColor(value) {
            if (value >= 0.7) return '#00b894';
            if (value >= 0.3) return '#6c5ce7';
            if (value >= -0.3) return '#fdcb6e';
            if (value >= -0.7) return '#ff7675';
            return '#ff4757';
        }

        function selectPair(stock1, stock2, correlation) {
            const s1 = preferredStocksInfo[stock1];
            const s2 = preferredStocksInfo[stock2];
            let analysis = `<strong>${stock1} vs ${stock2}</strong><br><br>`;
            // ... Detailed analysis HTML generation ... (kept concise for brevity)
             analysis += `<strong>Overall Correlation:</strong> <span style="color: ${getCorrelationColor(correlation)}; font-weight: bold;">${correlation.toFixed(3)}</span><br><br>`;
            if (s1 && s2 && s1.issuer === s2.issuer) {
                 analysis += `🏛️ <strong>Same Issuer:</strong> Both from ${s1.issuer}. This can lead to higher correlation due to shared company-specific risk.<br><br>`;
            }
             analysis += `When ${stock1}'s daily return changes, ${stock2}'s return tends to move ${correlation > 0 ? 'in the same direction' : 'in the opposite direction'}.`;
            DOMElements.pairAnalysis.innerHTML = analysis;
        }

        function updateStats() {
            const correlations = [];
            const stocks = Object.keys(correlationMatrix);
            stocks.forEach(s1 => stocks.forEach(s2 => { if (s1 < s2) correlations.push(correlationMatrix[s1][s2]); }));
            if (correlations.length === 0) return;
            const avg = correlations.reduce((a, b) => a + b, 0) / correlations.length;
            const strongPos = correlations.filter(c => c >= 0.7).length;
            const strongNeg = correlations.filter(c => c <= -0.7).length;
            DOMElements.statsContainer.innerHTML = `
                <div class="stat-card"><div class="stat-value">${avg.toFixed(3)}</div><div class="stat-label">Average Correlation</div></div>
                <div class="stat-card"><div class="stat-value">${Math.max(...correlations).toFixed(3)}</div><div class="stat-label">Highest Correlation</div></div>
                <div class="stat-card"><div class="stat-value">${Math.min(...correlations).toFixed(3)}</div><div class="stat-label">Lowest Correlation</div></div>
                <div class="stat-card"><div class="stat-value">${strongPos}</div><div class="stat-label">Strong Positive Pairs</div></div>
                <div class="stat-card"><div class="stat-value">${strongNeg}</div><div class="stat-label">Strong Negative Pairs</div></div>
                <div class="stat-card"><div class="stat-value">${stocks.length}</div><div class="stat-label">Total Stocks</div></div>
            `;
        }

        function updateApiStatus(status) {
            DOMElements.apiStatus.className = `api-status status-${status}`;
        }
        
        function showMessage(type, message) {
            DOMElements.apiMessage.innerHTML = `<div class="${type}">${message}</div>`;
        }

        // --- EVENT HANDLERS & ACTIONS ---
        function useRealData() {
            config.useDemo = false;
            updateApiStatus('loading');
            testApiConnectivity();
        }

        function useDemoData() {
            config.useDemo = true;
            updateApiStatus('online');
            showMessage('success', '📊 Demo data mode activated. Click "Refresh Data" to begin.');
            DOMElements.btnRefresh.disabled = false;
        }
        
        async function testApiConnectivity() {
            showMessage('success', '🔄 Testing API connectivity...');
            try {
                await fetchStockData('AAPL', '5'); // Test with a common stock
                updateApiStatus('online');
                showMessage('success', '🎉 API connection successful! Ready to fetch real market data.');
                DOMElements.btnRefresh.disabled = false;
            } catch (error) {
                updateApiStatus('offline');
                showMessage('error', `❌ API connection failed. Please <strong>configure your API keys</strong> or use <strong>demo data</strong>. The free AllOrigins proxy might be down.`);
                DOMElements.btnRefresh.disabled = true;
            }
        }

        async function addCustomStock() {
            const ticker = DOMElements.customTickerInput.value.trim().toUpperCase();
            if (!ticker || preferredStocksInfo[ticker]) {
                showMessage('error', `Ticker is empty or already exists: ${ticker}`);
                return;
            }
            
            showMessage('success', `🔍 Searching for details for ${ticker}...`);
            const details = await fetchStockDetails(ticker);

            preferredStocksInfo[ticker] = {
                name: details?.name || `Custom Stock`,
                type: 'Unknown', dividend: 'N/A', callDate: 'N/A', maturityDate: 'N/A',
                issuer: details?.issuer || 'Custom'
            };
            DOMElements.customTickerInput.value = '';
            displayStocksInfo();
            showMessage('success', `✅ ${ticker} added to analysis.`);
        }

        async function refreshMatrix() {
            DOMElements.btnRefresh.disabled = true;
            DOMElements.btnAddStock.disabled = true;
            await createCorrelationMatrix();
            DOMElements.btnRefresh.disabled = false;
            DOMElements.btnAddStock.disabled = false;
        }

    </script>
</body>
</html>
